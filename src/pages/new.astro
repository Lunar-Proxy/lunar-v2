---
import '@/main.css';
import Bookmarks from '../layouts/bookmark.astro';
---

<!doctype html>
<html lang="en" class="scroll-smooth">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="generator" content={Astro.generator} />
    <title>New Tab</title>

    <style>
      @layer utilities {
        @keyframes slideDown {
          0% {
            transform: translateY(-30%);
            opacity: 0;
          }
          100% {
            transform: translateY(0);
            opacity: 1;
          }
        }
        .animate-slideDown {
          animation: slideDown 0.35s ease-out;
        }
      }
    </style>
  </head>
  <body
    class="h-screen flex flex-col items-center justify-center bg-background text-text-header font-linux relative select-none"
  >
    <h1
      id="clock"
      class="text-8xl font-bold tracking-tight font-mono select-none"
      style="letter-spacing: 0;"
    >
      <span
        id="h"
        class="inline-block min-w-[1.5ch] text-center clock-part"
        >--</span
      >:<span
        id="m"
        class="inline-block min-w-[1.5ch] text-center clock-part"
        >--</span
      >:<span
        id="s"
        class="inline-block min-w-[1.5ch] text-center clock-part"
        >--</span
      >
      <span
        id="ampm"
        class="inline-block ml-1 text-4xl align-bottom clock-part"
      ></span>
    </h1>

    <p
      id="date"
      class="text-2xl text-text-secondary font-mono mt-4 select-none"
    ></p>

    <p
      id="weather"
      class="absolute top-4 right-4 px-6 py-3 rounded-xl text-[16px] font-bold font-linux text-text-secondary bg-background-overlay backdrop-blur-sm shadow-md select-none"
    ></p>

    <p
      id="battery"
      class="absolute top-4 left-4 px-6 py-3 rounded-xl text-[16px] font-bold font-linux text-text-secondary bg-background-overlay backdrop-blur-sm shadow-md select-none"
    ></p>

    <Bookmarks />

    <script>
      type ClockId = 'h' | 'm' | 's' | 'ampm';

      const clockIds: ClockId[] = ['h', 'm', 's', 'ampm'];
      const last: Record<ClockId, string> = {
        h: '',
        m: '',
        s: '',
        ampm: '',
      };

      function animateClock(id: ClockId, value: string) {
        const el = document.getElementById(id);
        if (!el) return;
        if (last[id] !== value) {
          el.textContent = value;
          el.classList.remove('animate-slideDown');
          void el.offsetWidth;
          el.classList.add('animate-slideDown');
          last[id] = value;
        }
      }

      function Clock() {
        const now = new Date();
        let hh = now.getHours();
        const ampm = hh >= 12 ? 'PM' : 'AM';
        hh = hh % 12 || 12;

        const hhStr = hh.toString().padStart(2, '0');
        const mmStr = now.getMinutes().toString().padStart(2, '0');
        const ssStr = now.getSeconds().toString().padStart(2, '0');

        animateClock('h', hhStr);
        animateClock('m', mmStr);
        animateClock('s', ssStr);
        animateClock('ampm', ampm);
      }

      async function DisplayInfo() {
        const todayDate = new Date();
        const dateElement = document.getElementById('date');
        if (dateElement) {
          dateElement.innerText = todayDate.toLocaleDateString(undefined, {
            weekday: 'long',
            month: 'long',
            day: 'numeric',
            year: 'numeric',
          });
        }

        const weatherCodes: Record<number, [string, string]> = {
          0: ['Clear', 'â˜€ï¸'],
          1: ['Mostly clear', 'ðŸŒ¤ï¸'],
          2: ['Partly cloudy', 'â›…'],
          3: ['Cloudy', 'â˜ï¸'],
          45: ['Fog', 'ðŸŒ«ï¸'],
          48: ['Freezing fog', 'ðŸŒ«ï¸'],
          51: ['Light drizzle', 'ðŸŒ¦ï¸'],
          53: ['Drizzle', 'ðŸŒ§ï¸'],
          55: ['Heavy drizzle', 'ðŸŒ§ï¸'],
          56: ['Freezing drizzle', 'ðŸŒ§ï¸'],
          57: ['Heavy freezing drizzle', 'ðŸŒ§ï¸'],
          61: ['Light rain', 'ðŸŒ§ï¸'],
          63: ['Rain', 'ðŸŒ§ï¸'],
          65: ['Heavy rain', 'ðŸŒ§ï¸'],
          66: ['Freezing rain', 'ðŸŒ§ï¸'],
          67: ['Heavy freezing rain', 'ðŸŒ§ï¸'],
          71: ['Light snow', 'ðŸŒ¨ï¸'],
          73: ['Snow', 'ðŸŒ¨ï¸'],
          75: ['Heavy snow', 'â„ï¸'],
          77: ['Snow grains', 'â„ï¸'],
          80: ['Rain showers', 'ðŸŒ¦ï¸'],
          81: ['Heavy rain showers', 'ðŸŒ§ï¸'],
          82: ['Violent rain showers', 'â›ˆï¸'],
          85: ['Snow showers', 'ðŸŒ¨ï¸'],
          86: ['Heavy snow showers', 'â„ï¸'],
          95: ['Thunderstorm', 'â›ˆï¸'],
          96: ['Thunderstorm with hail', 'â›ˆï¸'],
          99: ['Severe thunderstorm with hail', 'â›ˆï¸'],
        };

        try {
          const ipRes = await fetch('https://ipapi.co/json/');
          const ipData = await ipRes.json();
          const { latitude, longitude } = ipData;

          if (!latitude || !longitude) throw new Error('Could not determine location');

          const weatherRes = await fetch(
            `https://api.open-meteo.com/v1/forecast?latitude=${latitude}&longitude=${longitude}&current_weather=true&temperature_unit=fahrenheit`
          );
          const weatherData = await weatherRes.json();

          const weatherElement = document.getElementById('weather');
          if (weatherData.current_weather && weatherElement) {
            const weather = weatherData.current_weather;
            const roundedTemp = Math.round(weather.temperature);
            const code = Number(weather.weathercode);
            const info = weatherCodes[code];
            const display = info ? `${info[1]} ${info[0]}, ${roundedTemp}Â°F` : `${roundedTemp}Â°F`;
            weatherElement.innerText = display;
          } else if (weatherElement) {
            weatherElement.innerText = 'Weather unavailable';
          }
        } catch {
          const weatherElement = document.getElementById('weather');
          if (weatherElement) {
            weatherElement.innerText = 'Weather unavailable';
          }
        }
      }

      async function DisplayBattery() {
        try {
          // @ts-ignore
          const battery = await navigator.getBattery?.();
          const batteryElement = document.getElementById('battery');

          if (batteryElement && battery) {
            const updateBattery = () => {
              const level = Math.round(battery.level * 100);
              const charging = battery.charging ? 'âš¡' : '';
              batteryElement.innerText = `${charging} ${level}%`;
              batteryElement.classList.remove('fade-scale');
              void batteryElement.offsetWidth;
              batteryElement.classList.add('fade-scale');
            };

            updateBattery();
            battery.addEventListener('levelchange', updateBattery);
            battery.addEventListener('chargingchange', updateBattery);
          }
        } catch {}
      }

      DisplayInfo();
      DisplayBattery();
      Clock();
      setInterval(Clock, 1000);
    </script>
  </body>
</html>
