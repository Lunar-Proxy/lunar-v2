---
import '@/main.css';
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="generator" content={Astro.generator} />
    <title>New Tab</title>
  </head>
  <body class="h-screen flex items-center justify-center flex-col relative">
    <h1 class="text-8xl text-text-header font-linux font-bold" id="clock"></h1>
    <p id="date" class="text-xl text-text-secondary font-mono mt-2"></p>
    <p
      id="weather"
      class="absolute top-4 right-4 text-text-secondary font-linux px-6 py-3 rounded-xl text-[16px] font-bold"
    >
    </p>
    <p
      id="battery"
      class="absolute top-4 left-4 text-text-secondary font-linux px-6 py-3 rounded-xl text-[16px] font-bold"
    >
    </p>
  </body>
  <script>
    function Clock() {
      const now = new Date();
      const clockElement = document.getElementById('clock');
      if (clockElement) {
        clockElement.innerText = now.toLocaleTimeString([], { hour12: false });
      }
    }

    async function DisplayInfo() {
      const todayDate = new Date();
      const dateElement = document.getElementById('date');
      if (dateElement) {
        dateElement.innerText = todayDate.toLocaleDateString([], {
          weekday: 'long',
          month: 'long',
          day: 'numeric',
          year: 'numeric',
        });
      }

      const weatherCodes = {
        0: ['Clear', 'â˜€ï¸'],
        1: ['Mostly clear', 'ðŸŒ¤ï¸'],
        2: ['Partly cloudy', 'â›…'],
        3: ['Cloudy', 'â˜ï¸'],
        45: ['Fog', 'ðŸŒ«ï¸'],
        48: ['Freezing fog', 'ðŸŒ«ï¸'],
        51: ['Light drizzle', 'ðŸŒ¦ï¸'],
        53: ['Drizzle', 'ðŸŒ§ï¸'],
        55: ['Heavy drizzle', 'ðŸŒ§ï¸'],
        56: ['Freezing drizzle', 'ðŸŒ§ï¸'],
        57: ['Heavy freezing drizzle', 'ðŸŒ§ï¸'],
        61: ['Light rain', 'ðŸŒ§ï¸'],
        63: ['Rain', 'ðŸŒ§ï¸'],
        65: ['Heavy rain', 'ðŸŒ§ï¸'],
        66: ['Freezing rain', 'ðŸŒ§ï¸'],
        67: ['Heavy freezing rain', 'ðŸŒ§ï¸'],
        71: ['Light snow', 'ðŸŒ¨ï¸'],
        73: ['Snow', 'ðŸŒ¨ï¸'],
        75: ['Heavy snow', 'â„ï¸'],
        77: ['Snow grains', 'â„ï¸'],
        80: ['Rain showers', 'ðŸŒ¦ï¸'],
        81: ['Heavy rain showers', 'ðŸŒ§ï¸'],
        82: ['Violent rain showers', 'â›ˆï¸'],
        85: ['Snow showers', 'ðŸŒ¨ï¸'],
        86: ['Heavy snow showers', 'â„ï¸'],
        95: ['Thunderstorm', 'â›ˆï¸'],
        96: ['Thunderstorm with hail', 'â›ˆï¸'],
        99: ['Severe thunderstorm with hail', 'â›ˆï¸'],
      };

      try {
        const ipRes = await fetch('https://ipapi.co/json/');
        const ipData = await ipRes.json();
        const { latitude, longitude } = ipData;

        if (!latitude || !longitude) throw new Error('Could not determine location');

        const weatherRes = await fetch(
          `https://api.open-meteo.com/v1/forecast?latitude=${latitude}&longitude=${longitude}&current_weather=true&temperature_unit=fahrenheit`,
        );
        const weatherData = await weatherRes.json();

        const weatherElement = document.getElementById('weather');
        if (weatherData.current_weather && weatherElement) {
          const weather = weatherData.current_weather;
          const roundedTemp = Math.round(weather.temperature);
          const code = Number(weather.weathercode) as keyof typeof weatherCodes;
          const info = weatherCodes[code];
          const display = info ? `${info[1]} ${info[0]}, ${roundedTemp}Â°F` : `${roundedTemp}Â°F`;
          weatherElement.innerText = display;
        } else if (weatherElement) {
          weatherElement.innerText = 'Weather unavailable';
        }
      } catch (error) {
        console.error('error fetching weather:', error);
        const weatherElement = document.getElementById('weather');
        if (weatherElement) {
          weatherElement.innerText = 'Weather unavailable';
        }
      }
    }

    async function DisplayBattery() {
      try {
        const battery = await (navigator as any).getBattery();
        const batteryElement = document.getElementById('battery');
        if (batteryElement) {
          const updateBattery = () => {
            const level = Math.round(battery.level * 100);
            const charging = battery.charging ? 'âš¡' : '';
            batteryElement.innerText = `${charging} ${level}%`;
          };
          updateBattery();
          battery.addEventListener('levelchange', updateBattery);
          battery.addEventListener('chargingchange', updateBattery);
        }
      } catch (err) {
        console.error('Battery status error:', err);
      }
    }

    DisplayInfo();
    DisplayBattery();
    Clock();
    setInterval(Clock, 1000);
  </script>
</html>
