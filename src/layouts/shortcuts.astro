---
import ImportLucide from '../layouts/lucide.astro';
---

<div id="logo-container-wrapper" class="relative mt-10 flex flex-row flex-wrap items-center justify-start gap-6">
  <div id="logo-container" class="flex flex-row flex-wrap items-start gap-6"></div>
</div>

<ImportLucide />

<script>
  import ConfigAPI from '../utils/config';

  interface Bookmark {
    name: string;
    redir: string;
  }

  const container = document.getElementById('logo-container') as HTMLDivElement;
  let bookmarks: Bookmark[] = [];

  function render() {
    container.innerHTML = '';
    bookmarks.forEach((bm, i) => {
      const div = document.createElement('div');
      div.className =
        'relative flex flex-col items-center justify-center space-y-3 transform transition-all duration-300 hover:scale-105 cursor-pointer group';

      const logoUrl = `/api/icon/?url=${bm.redir}`;

      div.innerHTML = `
        <div class="absolute -top-2 -right-2 flex space-x-1 z-10 opacity-0 group-hover:opacity-100 transition-all duration-300">
          <button class="delete bg-red-500/80 hover:bg-red-500 rounded-full p-1.5 transition-all duration-200 shadow-lg hover:shadow-xl backdrop-blur-sm">
            <i data-lucide="trash-2" class="h-3.5 w-3.5 text-white"></i>
          </button>
        </div>
        <div class="w-16 h-16 rounded-2xl bg-background-overlay/60 backdrop-blur-sm border border-border-default/20 flex items-center justify-center overflow-hidden shadow-lg group-hover:shadow-xl transition-all duration-300 group-hover:border-text-secondary/30">
          <img src="${logoUrl}" alt="${bm.name}" class="object-contain w-10 h-10 transition-transform duration-300 group-hover:scale-110" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';" />
          <div class="hidden w-10 h-10 items-center justify-center">
            <i data-lucide="globe" class="h-6 w-6 text-text-secondary"></i>
          </div>
        </div>
        <div class="text-center">
          <p class="text-sm font-medium text-text-header group-hover:text-text-header max-w-[80px] break-words transition-colors duration-200">
            ${bm.name}
          </p>
        </div>
      `;

      (div.querySelector('.delete') as HTMLButtonElement).addEventListener('click', async e => {
        e.stopPropagation();
        bookmarks.splice(i, 1);
        await ConfigAPI.set('bm', bookmarks);
        render();
      });

      div.addEventListener('click', () => {
        const input = window.parent.document.getElementById('urlbar') as HTMLInputElement | null;
        if (input) {
          input.value = bm.redir;
          input.dispatchEvent(new KeyboardEvent('keydown', { key: 'Enter' }));
        }
      });

      container.appendChild(div);
    });
  }

  async function init() {
    const raw = await ConfigAPI.get('bm');
    bookmarks = Array.isArray(raw) ? raw.map((b: any) => ({ name: b.name, redir: b.redir || '' })) : [];
    render();
  }

  init();
</script>
