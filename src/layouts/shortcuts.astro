---
import ImportLucide from '../layouts/lucide.astro';
---

<div class="relative mt-10 flex w-full max-w-4xl flex-row flex-wrap items-center justify-center gap-7 px-2">
  <div id="shortcuts" class="flex w-full flex-row flex-wrap items-start justify-center gap-7"></div>
</div>

<ImportLucide />

<script>
  import ConfigAPI from '../utils/config';
  import * as baremux from '@mercuryworkshop/bare-mux';

  interface Bookmark {
    name: string;
    redir: string;
  }

  const moonIcon = '/a/moon.svg';
  const FAVICON_API =
    'https://t2.gstatic.com/faviconV2?client=SOCIAL&type=FAVICON&fallback_opts=TYPE,SIZE,URL&size=64';
  const iconApi = FAVICON_API + '&url=';
  const connection = new baremux.BareMuxConnection("/bm/worker.js");
  const client = new baremux.BareClient();
  const container = document.getElementById('shortcuts') as HTMLDivElement;
  let bookmarks: Bookmark[] = [];


  async function getIcon(url: string): Promise<string> {
    if (!url) return moonIcon;
    try {
      const res = await client.fetch(iconApi + encodeURIComponent(url));
      if (!res.ok) throw new Error('fail');
      const blob = await toBase64(await res.blob());
      if (blob) return blob;
    } catch {}
    return moonIcon;
  }

  function toBase64(blob: Blob): Promise<string> {
    return new Promise((resolve, reject) => {
      const r = new FileReader();
      r.onloadend = () => resolve(r.result as string);
      r.onerror = reject;
      r.readAsDataURL(blob);
    });
  }

  async function render() {
    container.innerHTML = '';
    const wispUrlRaw = await ConfigAPI.get('wispUrl');
    const wispUrl = typeof wispUrlRaw === 'string' ? wispUrlRaw : '';
    if (await connection.getTransport() !== '/lc/index.mjs') {
      await connection.setTransport('/lc/index.mjs', [{ wisp: wispUrl }]);
    }
    const iconPromises = bookmarks.map(bm => getIcon(bm.redir));
    const iconSrcs = await Promise.all(iconPromises);
    for (let i = 0; i < bookmarks.length; i++) {
      const bm = bookmarks[i];
      const div = document.createElement('div');
      div.className =
        'shortcut-card relative flex flex-col items-center justify-center space-y-3 rounded-2xl bg-background-overlay/80 border border-border-default/20 p-5 min-w-[120px] max-w-[160px] transition-all duration-200 hover:scale-105 cursor-pointer group backdrop-blur-md shadow-lg';

      const iconSrc = iconSrcs[i];

      div.innerHTML = `
        <div class="absolute -top-2 -right-2 flex z-10 opacity-0 group-hover:opacity-100 transition-all duration-200">
          <button class="delete bg-red-500/70 hover:bg-red-600 rounded-full p-1.5 transition-all duration-150 shadow-sm backdrop-blur-sm">
            <i data-lucide="trash-2" class="h-3 w-3 text-white"></i>
          </button>
        </div>
        <div class="w-16 h-16 rounded-xl bg-background-overlay/90 backdrop-blur border border-border-default/20 flex items-center justify-center overflow-hidden group-hover:border-text-secondary/30 transition-all duration-200 shadow-md">
          <img src="${iconSrc}" alt="${bm.name}" class="object-contain w-10 h-10 transition-transform duration-200 group-hover:scale-110" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';" />
          <div class="hidden w-10 h-10 items-center justify-center">
            <i data-lucide="globe" class="h-6 w-6 text-text-secondary"></i>
          </div>
        </div>
        <div class="text-center mt-2">
          <p class="text-base font-semibold text-text-header group-hover:text-white max-w-[120px] break-words transition-colors duration-150">
            ${bm.name}
          </p>
        </div>
      `;

      (div.querySelector('.delete') as any).addEventListener('click', async (e: { stopPropagation: () => void; }) => {
        e.stopPropagation();
        bookmarks.splice(i, 1);
        await ConfigAPI.set('bm', bookmarks);
        render();
      });

      div.addEventListener('click', () => {
        const input = window.parent.document.getElementById('urlbar');
        if (input && 'value' in input) {
          (input as HTMLInputElement).value = bm.redir;
          input.dispatchEvent(new KeyboardEvent('keydown', { key: 'Enter' }));
        }
      });

      container.appendChild(div);
    }
  }

  async function init() {
    await ConfigAPI.init();
    const raw = await ConfigAPI.get('bm');
    bookmarks = Array.isArray(raw) ? raw.map((b: any) => ({ name: b.name, redir: b.redir || '' })) : [];
    render();
  }

  init();
</script>
